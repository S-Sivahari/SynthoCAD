<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynthoCAD</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Three.js r128 + OrbitControls via CDN (r128 is the last version with stable global THREE.OrbitControls) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- occt-import-js: OpenCASCADE WASM for STEP parsing (0.0.23 = latest; global: occtimportjs) -->
    <script src="https://cdn.jsdelivr.net/npm/occt-import-js@0.0.23/dist/occt-import-js.js"></script>
</head>

<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <h1 class="header-title">SYNTHOCAD</h1>
                <p class="header-subtitle">AI-Powered Parametric CAD Generation Platform</p>
            </div>
        </header>

        <!-- Main Layout -->
        <main class="main">
            <!-- Left Column: Input Area -->
            <aside class="left-column">
                <!-- Section A: Prompt Input -->
                <section class="input-section">
                    <label class="section-label">PROMPT</label>
                    <textarea id="prompt-input" class="prompt-textarea"
                        placeholder="Create a cylinder diameter 20mm height 50mm with center hole 5mm"
                        rows="6"></textarea>
                    <button id="generate-btn" class="generate-btn">Generate</button>
                    <div id="error-message" class="error-message"></div>
                </section>

                <!-- Section B: Upload & Preview STEP -->
                <section class="upload-section">
                    <label class="section-label">UPLOAD &amp; PREVIEW STEP</label>
                    <div id="drop-zone" class="drop-zone">
                        <input type="file" id="step-file-input" accept=".step,.stp" class="drop-zone-input">
                        <div class="drop-zone-content">
                            <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                            </svg>
                            <span id="drop-zone-text">Drop .step file or click to browse</span>
                        </div>
                    </div>
                    <div class="upload-btn-row">
                        <button id="preview-btn" class="preview-btn" disabled>Preview</button>
                        <button id="view3d-btn" class="view3d-btn" disabled>View 3D</button>
                    </div>
                    <div id="preview-error" class="error-message"></div>

                    <!-- Edit prompt (shown after preview) -->
                    <div id="edit-area" class="edit-area hidden">
                        <label class="section-label" style="margin-top:12px">EDIT PROMPT</label>
                        <textarea id="edit-prompt-input" class="prompt-textarea"
                            placeholder="e.g. change f2 radius to 8mm" rows="3"></textarea>
                        <button id="edit-btn" class="generate-btn">Edit STEP</button>
                        <div id="edit-error" class="error-message"></div>
                    </div>
                </section>

                <!-- Section C: Templates -->
                <section class="templates-section">
                    <label class="section-label">TEMPLATES</label>
                    <select id="templates-select" class="templates-select">
                        <option value="">Select a template...</option>
                    </select>
                </section>
            </aside>

            <!-- Right Column: Output Workspace -->
            <section class="right-column">
                <!-- Tabs -->
                <nav class="tabs">
                    <button class="tab active" data-tab="viewer3d">3D Viewer</button>
                    <button class="tab" data-tab="preview">Preview</button>
                    <button class="tab" data-tab="json">JSON</button>
                    <button class="tab" data-tab="python">Python</button>
                    <button class="tab" data-tab="step">STEP</button>
                    <button class="tab" data-tab="parameters">Parameters</button>
                </nav>

                <!-- Tab Panels -->
                <div class="tab-panels">
                    <!-- FreeCAD Model: Three.js STEP Viewer -->
                    <div class="tab-panel active" id="panel-freecad">
                        <div id="step3d-container">
                            <canvas id="step3d-canvas"></canvas>
                            <!-- Status overlay -->
                            <div id="step3d-status">Drop or generate a STEP file to view in 3D</div>
                            <!-- Loading spinner overlay -->
                            <div id="step3d-loading" class="step3d-loading hidden">
                                <div class="step3d-spinner"></div>
                                <span id="step3d-loading-text">Loading…</span>
                            </div>
                            <!-- Viewer toolbar -->
                            <div class="step3d-toolbar">
                                <button class="step3d-btn" id="step3d-btn-reset" onclick="stepViewer.resetView()"
                                    title="Fit to view">⊡ Fit</button>
                                <button class="step3d-btn" id="step3d-btn-wire" onclick="stepViewer.toggleWireframe()"
                                    title="Toggle wireframe">⬡ Wire</button>
                            </div>
                            <!-- Face-click tooltip -->
                            <div id="step3d-face-tip" class="step3d-face-tip" style="display:none;"></div>
                        </div>
                        <button id="visualize-btn" class="visualize-btn hidden">Visualize Model</button>
                    </div>

                    <!-- Preview (7-angle image viewer) -->
                    <div class="tab-panel" id="panel-preview">
                        <div id="preview-placeholder" class="placeholder">
                            <p>Upload a STEP file and click Preview to see annotated views</p>
                        </div>
                        <div id="preview-viewer" class="preview-viewer hidden">
                            <!-- Thumbnail strip -->
                            <div id="view-strip" class="view-strip"></div>
                            <!-- Zoom toolbar -->
                            <div class="zoom-toolbar">
                                <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">−</button>
                                <button class="zoom-btn" onclick="zoomReset()" title="Reset zoom">
                                    <span id="zoom-pct">100%</span>
                                </button>
                                <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">+</button>
                                <span class="zoom-hint">Scroll wheel to zoom</span>
                            </div>
                            <!-- Main large image -->
                            <div class="view-main-wrap">
                                <img id="view-main-img" class="view-main-img" src="" alt="CAD view">
                                <span id="view-main-label" class="view-main-label"></span>
                            </div>
                        </div>
                    </div>

                    <!-- JSON -->
                    <div class="tab-panel" id="panel-json">
                        <div class="code-container">
                            <pre id="json-viewer" class="code-viewer">Generate a model to view JSON output</pre>
                        </div>
                    </div>

                    <!-- Python -->
                    <div class="tab-panel" id="panel-python">
                        <div class="code-container">
                            <pre id="python-viewer" class="code-viewer">Generate a model to view Python code</pre>
                        </div>
                    </div>

                    <!-- STEP -->
                    <div class="tab-panel" id="panel-step">
                        <div class="step-info" id="step-info">
                            <p class="step-placeholder">Generate a model to view STEP file</p>
                        </div>
                    </div>

                    <!-- Parameters -->
                    <div class="tab-panel" id="panel-parameters">
                        <div class="parameters-container">
                            <div id="parameters-form" class="parameters-form">
                                <p class="params-placeholder">Generate a model to edit parameters</p>
                            </div>
                            <button id="regenerate-btn" class="regenerate-btn hidden">Regenerate Model</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="spinner"></div>
                <p id="loading-message">Processing...</p>
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="toast-container"></div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/step-viewer.js"></script>
    <script src="js/app.js"></script>
</body>

</html>